name: "ğŸ” PR Check"

on:
  pull_request:
    # Draftè§£é™¤å¾Œã«ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒé€²ã‚€å ´é¢ã®ã¿CIã‚’èµ°ã‚‰ã›ã‚‹
    types: [opened, synchronize, ready_for_review]
    # CIå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã«å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã«ã®ã¿ãƒˆãƒªã‚¬ãƒ¼
    paths:
      - 'src/**'
      - 'test/**'
      - '.github/**'
      - 'package.json'
      - 'package-lock.json'
      - 'tsconfig.json'
  # æ‰‹å‹•ã§å†å®Ÿè¡Œã—ãŸã„å ´åˆã®é€ƒã’é“
  workflow_dispatch: {}

# åŒä¸€PRã§å¤ã„ã‚¸ãƒ§ãƒ–ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦Runnerãƒªã‚½ãƒ¼ã‚¹ã‚’ç¯€ç´„
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  # OSV-ScannerãŒçµæœã‚’ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦è¨˜éŒ²ã§ãã‚‹ã‚ˆã†ä»˜ä¸
  security-events: write

jobs:
  # TypeScript/ESLint/oxfmt ã‚’ã¾ã¨ã‚ã¦ä¸¦åˆ—æ¤œè¨¼ã™ã‚‹ã‚¸ãƒ§ãƒ–
  checks:
    name: ${{ matrix.check }}
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false # ã©ã‚Œã‹å¤±æ•—ã—ã¦ã‚‚æ®‹ã‚Šã®çµæœã‚’ç¢ºå®Ÿã«å¾—ã‚‹
      matrix:
        check: [typecheck, lint, format-check]
        include:
          - check: typecheck
            command: npm run typecheck
          - check: lint
            command: npm run lint
          - check: format-check
            # oxfmtã«--checkã‚’ä»˜ã‘ã¦å·®åˆ†æ¤œå‡ºã ã‘ã‚’è¡Œã†
            command: npm run format -- --check
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ${{ matrix.check }}
        run: ${{ matrix.command }}

  # ä¾å­˜é–¢ä¿‚ã®æ—¢çŸ¥è„†å¼±æ€§ã‚’OSVãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã‚¹ã‚­ãƒ£ãƒ³
  osv-scan:
    name: OSV Scanner
    runs-on: ubuntu-latest
    needs: checks
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Run OSV-Scanner
        uses: google/osv-scanner-action@v1
        with:
          scan-args: --lockfile package-lock.json

